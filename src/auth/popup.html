<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="Demonstrates how to authorize Firebase with Discord auth using Firebase Functions"
          name="description">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Authenticate with Discord</title>
</head>
<body>

Please wait...

<!--
<script src="/__/firebase/7.15.4/firebase-app.js"></script>
<script src="/__/firebase/7.15.4/firebase-auth.js"></script>
<script src="/__/firebase/init.js"></script> -->

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>

<script>
    let firebaseConfig = {
        apiKey: "AIzaSyButkqFXtrI90FUM-l7O-nWz-3TxIwd_0U",
        authDomain: "atlas-project-274801.firebaseapp.com",
        databaseURL: "https://atlas-project-274801.firebaseio.com",
        projectId: "atlas-project-274801",
        storageBucket: "atlas-project-274801.appspot.com",
        messagingSenderId: "807372296549",
        appId: "1:807372296549:web:b1e8fc3be8c2a27488918c",
        measurementId: "G-40XQC6G6E4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
</script>


<script>
    /**
     * Returns the value of the given URL query parameter.
     */
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) ||
            [null, ''])[1].replace(/\+/g, '%20')) || null;
    }

    /**
     * Returns the ID of the Firebase project.
     */
    function getFirebaseProjectId() {
        return firebase.app().options.authDomain.split('.')[0];
    }

    /**
     * This callback is called by the JSONP callback of the 'token' Firebase Function with the Firebase auth token.
     */
    function tokenReceived(data) {
        if (data.token) {
            firebase.auth().signInWithCustomToken(data.token).then(function () {
                window.close();
            });
        } else {
            console.error(data);
            document.body.innerText = 'Error in the token Function: ' + data.error;
        }
    }

    const code = getURLParameter('code');
    const state = getURLParameter('state');
    const error = getURLParameter('error');
    if (error) {
        document.body.innerText = 'Error back from the Discord auth page: ' + error;
    } else if (!code) {
        // Start the auth flow.
        window.location.href = 'https://us-central1-' + getFirebaseProjectId() + '.cloudfunctions.net/redirect';
    } else {
        // Use JSONP to load the 'token' Firebase Function to exchange the auth code against a Firebase custom token.
        const script = document.createElement('script');
        script.type = 'text/javascript';
        // This is the URL to the HTTP triggered 'token' Firebase Function.
        // See https://firebase.google.com/docs/functions.
        let tokenFunctionURL = 'https://us-central1-' + getFirebaseProjectId() + '.cloudfunctions.net/token';
        script.src = tokenFunctionURL +
            '?code=' + encodeURIComponent(code) +
            '&state=' + encodeURIComponent(state) +
            '&callback=' + tokenReceived.name;
        document.head.appendChild(script);
    }
</script>
</body>
</html>